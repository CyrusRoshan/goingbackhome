<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display a map with a custom style</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="js/three.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link href="main.css" rel="stylesheet" />
    <link href="css/semantic.min.css" rel="stylesheet" />
  </head>
  <body>
    <div id="map"></div>
    <div id="overlay">
      <div id="hud"></div>
      <div id="dimmer" class="ui active dimmer">
        <div id="loader" class="ui text loader">
          Get Home Safely! Starting your flight...
        </div>
      </div>
      <div id="airplane">
        <!--<img src="airplane.png" height="100">-->
      </div>
    </div>

    <script src="js/hammer.min.js" type="module"></script>
    <script type="module">
      import { initAirplane } from "./airplane.js";

      let dimmerEl = document.getElementById("dimmer");

      //LIGHT: mapbox://styles/johnny5coder/ck9kkxb1z1vmr1iojge6490xw
      //DARK: mapbox://styles/johnny5coder/ck9kkvcao1vh71io7u2hji0kr
      mapboxgl.accessToken =
        "pk.eyJ1Ijoiam9obm55NWNvZGVyIiwiYSI6ImNrOWs1emJsajFycHgzZXF0ZmZrZ2pubnUifQ.1rLHck77FdpZGEUqR8Qn5g";
      let map = new mapboxgl.Map({
        container: "map", // container id
        style: "mapbox://styles/johnny5coder/ck9kkxb1z1vmr1iojge6490xw", //hosted style id
        center: [-77.38, 39], // starting position
        zoom: 10, // starting zoom
        interactive: false,
        pitch: 60, // pitch in degrees
        bearing: 0, // bearing in degrees
      });

      function easing(t) {
        return t * (2 - t);
      }

      let shouldTurn = false;
      let degreesToTurn = 0;
      let planeSpeed = 0.01;
      let isGamePaused = false;

      let marker = new mapboxgl.Marker()
        .setLngLat([12.550343, 55.665957])
        .addTo(map);

      map.on("load", function () {
        map.getCanvas().focus();

        //Do any Map Animations Here. To slow for the animate loop.
        setInterval(() => {
          if (isGamePaused) {
            return;
          }

          let { lat, lng } = map.getCenter();
          let easeOptions = {
            easing: easing,
          };
          if (shouldTurn) {
            easeOptions.bearing = map.getBearing() + degreesToTurn;
          }
          //based on the heading - change the lat long
          let headingSpeed = determineHeadingSpeed(
            map.getBearing() + degreesToTurn,
            planeSpeed
          );
          easeOptions.center = {
            lat: lat + headingSpeed.lat,
            lng: lng + headingSpeed.long,
          };

          console.log(map.getCenter());

          map.easeTo(easeOptions);
        }, 200);

        //Evt handler for plane turning
        function onPlaneTurn(isLevel, dToTurn) {
          if (!isLevel) {
            shouldTurn = true;
            degreesToTurn = dToTurn;
            return;
          }
          degreesToTurn = 0;
          shouldTurn = false;
        }

        //adjusts the plane speed
        function onSpeedChange(direction) {
          switch (direction) {
            case "up":
              planeSpeed = Math.max(0.01, planeSpeed + 0.01);
              break;
            case "down":
              planeSpeed = Math.max(0.01, planeSpeed - 0.01);
              break;
          }
        }

        function onPlanePause() {
          isGamePaused = !isGamePaused;
          if (isGamePaused) {
            // dimmerEl.classList.add("active");
          } else {
            // dimmerEl.classList.remove("active");
          }
        }

        //Calculates the right lat and long rate changes based on angle of flight
        function determineHeadingSpeed(bearing, rateOfChange) {
          let long =
            Math.sin(toRadians(bearing)) * (rateOfChange * Math.sqrt(2));
          let lat =
            Math.cos(toRadians(bearing)) * (rateOfChange * Math.sqrt(2));
          console.log(
            `Heading ${bearing} - speed in direction X: ${lat}, speed in direction Y:${long}`
          );
          return { lat, long };
        }

        function toRadians(angle) {
          return angle * (Math.PI / 180);
        }

        initAirplane({ onPlaneTurn, onSpeedChange, onPlanePause }, false);
        dimmerEl.classList.remove("active");
      });
    </script>
  </body>
</html>
